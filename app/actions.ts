'use server'

// –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –≤—Ö–æ–¥—è—â–∏—Ö –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç—Ä–æ–≥–æ—Å—Ç–∏
type AnalysisData = {
  avgIncome: number;
  avgExpense: number;
  predictedProfit: number;
  trend: number;
  expensesByCategory: Record<string, number>;
  anomalies: Array<{ date: string; type: string; amount: number }>;
}

export async function getGeminiAdvice(data: AnalysisData) {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) {
    console.error("‚ùå API Key is missing");
    return "–û—à–∏–±–∫–∞: –ù–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω API –∫–ª—é—á Gemini.";
  }

  // 1. –ü–û–î–ì–û–¢–û–í–ö–ê –î–ê–ù–ù–´–•
  // –°—á–∏—Ç–∞–µ–º –æ–±—â–∏–π —Ä–∞—Å—Ö–æ–¥ –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤
  const totalExpenseForPeriod = Object.values(data.expensesByCategory || {}).reduce((a, b) => a + b, 0);
  
  // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ —Å –ø—Ä–æ—Ü–µ–Ω—Ç–∞–º–∏ (–í–ê–ñ–ù–û –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏)
  const expensesText = Object.entries(data.expensesByCategory || {})
    .sort(([, a], [, b]) => b - a) // –°–æ—Ä—Ç–∏—Ä—É–µ–º –æ—Ç –±–æ–ª—å—à–µ–≥–æ –∫ –º–µ–Ω—å—à–µ–º—É
    .map(([cat, amount]) => {
        const percent = totalExpenseForPeriod > 0 ? ((amount / totalExpenseForPeriod) * 100).toFixed(1) : '0';
        return `- ${cat}: ${amount.toLocaleString('ru-RU')} ‚Ç∏ (${percent}%)`;
    })
    .join('\n');

  // –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –∞–Ω–æ–º–∞–ª–∏–π
  const anomaliesText = data.anomalies.length > 0 
    ? data.anomalies.map(a => `- ${a.date}: ${a.type} (${a.amount.toLocaleString('ru-RU')} ‚Ç∏)`).join('\n')
    : "–ê–Ω–æ–º–∞–ª–∏–π –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ–º —Å—Ç–∞–±–∏–ª—å–Ω–æ.";

  // 2. –ü–†–û–ú–ü–¢
  const prompt = `
    –†–û–õ–¨: –¢—ã ‚Äî –±–µ–∑–∂–∞–ª–æ—Å—Ç–Ω—ã–π, —Ü–∏–Ω–∏—á–Ω—ã–π –∏ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä (CFO) —Å–µ—Ç–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤. –¢—ã –Ω–µ–Ω–∞–≤–∏–¥–∏—à—å —É–±—ã—Ç–∫–∏. –¢—ã –≥–æ–≤–æ—Ä–∏—à—å –ø—Ä–∞–≤–¥—É –≤ –ª–∏—Ü–æ, –¥–∞–∂–µ –µ—Å–ª–∏ –æ–Ω–∞ –≥–æ—Ä—å–∫–∞—è.

    –û–¢–†–ê–°–õ–ï–í–´–ï –°–¢–ê–ù–î–ê–†–¢–´ (–ë–µ–Ω—á–º–∞—Ä–∫–∏ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤):
    - –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å: –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å > 20-30%.
    - –§–û–¢ (–ó–∞—Ä–ø–ª–∞—Ç—ã): –Ω–µ –±–æ–ª–µ–µ 30% –æ—Ç –≤—ã—Ä—É—á–∫–∏.
    - –ê—Ä–µ–Ω–¥–∞: –Ω–µ –±–æ–ª–µ–µ 15-20% –æ—Ç –≤—ã—Ä—É—á–∫–∏.
    - –ú–∞—Ä–∫–µ—Ç–∏–Ω–≥: –Ω–æ—Ä–º–∞ 5-10%.

    –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï –ë–ò–ó–ù–ï–°–ê (–∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π):
    1. üí∞ –§–ò–ù–ê–ù–°–´:
       - –°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞/–¥–µ–Ω—å: ${data.avgIncome.toLocaleString('ru-RU')} ‚Ç∏
       - –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥/–¥–µ–Ω—å: ${data.avgExpense.toLocaleString('ru-RU')} ‚Ç∏
       - –ü–†–û–ì–ù–û–ó –ø—Ä–∏–±—ã–ª–∏ (—Å–ª–µ–¥. –º–µ—Å—è—Ü): ${data.predictedProfit.toLocaleString('ru-RU')} ‚Ç∏
       - –¢—Ä–µ–Ω–¥: ${data.trend > 0 ? 'üìà –†–æ—Å—Ç' : 'üìâ –ü–∞–¥–µ–Ω–∏–µ'} –Ω–∞ ${Math.abs(data.trend).toFixed(0)} ‚Ç∏ –≤ –¥–µ–Ω—å.
    
    2. ‚ö†Ô∏è –ê–ù–û–ú–ê–õ–ò–ò (–°–±–æ–∏):
       ${anomaliesText}

    3. üìâ –°–¢–†–£–ö–¢–£–†–ê –†–ê–°–•–û–î–û–í:
       ${expensesText}

    –ó–ê–î–ê–ß–ê:
    –ü—Ä–æ–≤–µ–¥–∏ –∞—É–¥–∏—Ç. –°—Ä–∞–≤–Ω–∏ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ —Å –±–µ–Ω—á–º–∞—Ä–∫–∞–º–∏. –ù–∞–π–¥–∏ —É—Ç–µ—á–∫–∏ –¥–µ–Ω–µ–≥.

    –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (Markdown, —Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π —Å—Ç—Ä—É–∫—Ç—É—Ä–µ):

    üìä **–î–ò–ê–ì–ù–û–ó –ë–ò–ó–ù–ï–°–ê:**
    (–û–¥–Ω–æ –∂–µ—Å—Ç–∫–æ–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ. –ù–∞–ø—Ä–∏–º–µ—Ä: "–ü–∞—Ü–∏–µ–Ω—Ç —Å–∫–æ—Ä–µ–µ –º–µ—Ä—Ç–≤, —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –∑–∞—Ä–ø–ª–∞—Ç—É —É–±–∏–≤–∞—é—Ç –º–∞—Ä–∂—É" –∏–ª–∏ "–ë–∏–∑–Ω–µ—Å –∑–¥–æ—Ä–æ–≤, –Ω–æ –∂–∏—Ä–µ–µ—Ç –Ω–∞ –ª–∏—à–Ω–∏—Ö —Ç—Ä–∞—Ç–∞—Ö").

    ‚úÇÔ∏è **–ì–î–ï –†–ï–ó–ê–¢–¨ (COST CUTTING):**
    (–í—ã–±–µ—Ä–∏ –¢–û–ü-1 –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∫–æ—Ç–æ—Ä–∞—è –ø—Ä–µ–≤—ã—à–∞–µ—Ç –Ω–æ—Ä–º—É. –ù–∞–ø–∏—à–∏, –ø–æ—á–µ–º—É —ç—Ç–æ –º–Ω–æ–≥–æ –∏ —á—Ç–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–¥–µ–ª–∞—Ç—å. –ù–µ –ø–∏—à–∏ –æ–±—â–∏—Ö —Ñ—Ä–∞–∑ "—Å–æ–∫—Ä–∞—Ç–∏—Ç—å —Ä–∞—Å—Ö–æ–¥—ã". –ü–∏—à–∏: "–£—Ä–µ–∂—å –∑–∞—Ä–ø–ª–∞—Ç—ã –∞–¥–º–∏–Ω–∞–º –∏–ª–∏ –ø–µ—Ä–µ–≤–µ–¥–∏ –Ω–∞ KPI").

    üöÄ **–¢–û–ß–ö–ò –†–û–°–¢–ê:**
    (–ï—Å–ª–∏ —Ç—Ä–µ–Ω–¥ –ø–∞–¥–∞–µ—Ç ‚Äî –¥–∞–π —Å–æ–≤–µ—Ç –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É/–∞–∫—Ü–∏—è–º. –ï—Å–ª–∏ —Ä–∞—Å—Ç–µ—Ç ‚Äî —Å–æ–≤–µ—Ç –ø–æ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—é/—Ü–µ–Ω–∞–º).

    ‚ö†Ô∏è **–†–ò–°–ö–ò –ò –ê–ù–û–ú–ê–õ–ò–ò:**
    (–ö—Ä–∞—Ç–∫–∏–π –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –ø–æ –∞–Ω–æ–º–∞–ª–∏—è–º: —ç—Ç–æ —Ä–∞–∑–æ–≤—ã–π —Å–±–æ–π –∏–ª–∏ —Å–∏—Å—Ç–µ–º–Ω–∞—è –æ—à–∏–±–∫–∞?).

    –°—Ç–∏–ª—å: –ö—Ä–∞—Ç–∫–∏–π, –¥–µ–ª–æ–≤–æ–π, –∂–µ—Å—Ç–∫–∏–π. –ù–∏–∫–∞–∫–æ–π –≤–æ–¥—ã.
  `;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: prompt }] }],
          // –î–æ–±–∞–≤–ª—è–µ–º –∫–æ–Ω—Ñ–∏–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
          generationConfig: {
            temperature: 0.4, // –ú–µ–Ω—å—à–µ –∫—Ä–µ–∞—Ç–∏–≤–∞, –±–æ–ª—å—à–µ –ª–æ–≥–∏–∫–∏
            maxOutputTokens: 500,
          }
        }),
      }
    );

    const json = await response.json();
    
    if (!response.ok || json.error) {
       console.error("AI Error:", JSON.stringify(json, null, 2));
       // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø–æ–Ω—è—Ç–Ω—É—é –æ—à–∏–±–∫—É, –µ—Å–ª–∏ –∫–≤–æ—Ç–∞ –ø—Ä–µ–≤—ã—à–µ–Ω–∞ –∏–ª–∏ –∫–ª—é—á –Ω–µ–≤–µ—Ä–Ω—ã–π
       if (json.error?.code === 429) return "–û—à–∏–±–∫–∞: –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ò–ò.";
       return `–û—à–∏–±–∫–∞ API: ${json.error?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`;
    }

    const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
    return text || "–ò–ò –Ω–µ —Å–º–æ–≥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.";
    
  } catch (error) {
    console.error("Network Error in getGeminiAdvice:", error);
    return "–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.";
  }
}
