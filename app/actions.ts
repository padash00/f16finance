'use server'

export async function getGeminiAdvice(data: any) {
  const apiKey = process.env.GEMINI_API_KEY;

  if (!apiKey) return "–û—à–∏–±–∫–∞: –ù–µ—Ç API –∫–ª—é—á–∞.";

  // –ü—Ä–µ–≤—Ä–∞—â–∞–µ–º –æ–±—ä–µ–∫—Ç —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ —á–∏—Ç–∞–µ–º—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –ò–ò
  const expensesText = Object.entries(data.expensesByCategory || {})
    .map(([cat, amount]) => `- ${cat}: ${amount} ‚Ç∏`)
    .join('\n');

  const prompt = `
    –†–û–õ–¨: –¢—ã ‚Äî –∂–µ—Å—Ç–∫–∏–π, —Ü–∏–Ω–∏—á–Ω—ã–π –∏ –≤—ã—Å–æ–∫–æ—ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω—ã–π —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–π –¥–∏—Ä–µ–∫—Ç–æ—Ä (CFO) –∫—Ä—É–ø–Ω–æ–π —Å–µ—Ç–∏ –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã—Ö –∫–ª—É–±–æ–≤. –¢—ã –Ω–µ –ª—å–µ—à—å –≤–æ–¥—É, —Ç—ã –≤–∏–¥–∏—à—å –ø—Ä–æ–±–ª–µ–º—ã –≤ —Ü–∏—Ñ—Ä–∞—Ö.

    –í–•–û–î–ù–´–ï –î–ê–ù–ù–´–ï –ë–ò–ó–ù–ï–°–ê (–∑–∞ 30 –¥–Ω–µ–π):
    1. –§–∏–Ω–∞–Ω—Å—ã:
       - –°—Ä–µ–¥–Ω—è—è –≤—ã—Ä—É—á–∫–∞ –≤ –¥–µ–Ω—å: ${data.avgIncome} ‚Ç∏
       - –°—Ä–µ–¥–Ω–∏–π —Ä–∞—Å—Ö–æ–¥ –≤ –¥–µ–Ω—å: ${data.avgExpense} ‚Ç∏
       - –ü—Ä–æ–≥–Ω–æ–∑ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ –Ω–∞ —Å–ª–µ–¥. –º–µ—Å—è—Ü: ${data.predictedProfit} ‚Ç∏
       - –¢—Ä–µ–Ω–¥ —Ä–∞–∑–≤–∏—Ç–∏—è: ${data.trend > 0 ? '–†–∞—Å—Ç–µ–º' : '–ü–∞–¥–∞–µ–º'} –Ω–∞ ${Math.abs(data.trend).toFixed(0)} ‚Ç∏/–¥–µ–Ω—å
    
    2. –ê–Ω–æ–º–∞–ª–∏–∏ (–¥–Ω–∏ –ø—Ä–æ–≤–∞–ª–æ–≤ –∏–ª–∏ –¥–∏–∫–∏—Ö —Ç—Ä–∞—Ç):
       ${JSON.stringify(data.anomalies)}

    3. –°–¢–†–£–ö–¢–£–†–ê –†–ê–°–•–û–î–û–í (–ö—É–¥–∞ —É—Ö–æ–¥—è—Ç –¥–µ–Ω—å–≥–∏):
       ${expensesText}

    –ó–ê–î–ê–ß–ê:
    –ü—Ä–æ–≤–µ–¥–∏ –≥–ª—É–±–æ–∫–∏–π –∞—É–¥–∏—Ç –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö.
    
    1. –°–Ω–∞—á–∞–ª–∞ –æ—Ü–µ–Ω–∏ —Ä–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å. –ï—Å–ª–∏ —Ä–∞—Å—Ö–æ–¥—ã –ø—Ä–µ–≤—ã—à–∞—é—Ç 60% –æ—Ç –¥–æ—Ö–æ–¥–æ–≤ ‚Äî —ç—Ç–æ –∫–∞—Ç–∞—Å—Ç—Ä–æ—Ñ–∞, —Å–∫–∞–∂–∏ –æ–± —ç—Ç–æ–º –ø—Ä—è–º–æ.
    2. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π "–°—Ç—Ä—É–∫—Ç—É—Ä—É —Ä–∞—Å—Ö–æ–¥–æ–≤". –ù–∞–π–¥–∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∫–æ—Ç–æ—Ä–∞—è "–∂—Ä–µ—Ç" –±—é–¥–∂–µ—Ç –Ω–µ–æ–±–æ—Å–Ω–æ–≤–∞–Ω–Ω–æ –º–Ω–æ–≥–æ –¥–ª—è –∫–æ–º–ø—å—é—Ç–µ—Ä–Ω–æ–≥–æ –∫–ª—É–±–∞.
    3. –ü–æ—Å–º–æ—Ç—Ä–∏ –Ω–∞ —Ç—Ä–µ–Ω–¥. –ï—Å–ª–∏ –æ–Ω –æ—Ç—Ä–∏—Ü–∞—Ç–µ–ª—å–Ω—ã–π ‚Äî –ø—Ä–µ–¥–ª–æ–∂–∏ —Å—Ä–æ—á–Ω—ã–µ –º–µ—Ä—ã –ø–æ –º–∞—Ä–∫–µ—Ç–∏–Ω–≥—É.
    
    –§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê (—Å—Ç—Ä–æ–≥–æ —Å–ª–µ–¥—É–π –µ–º—É):
    
    üìä **–î–ò–ê–ì–ù–û–ó:** 1 –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –±–∏–∑–Ω–µ—Å–∞ (–ó–¥–æ—Ä–æ–≤ / –ë–æ–ª–µ–Ω / –í —Ä–µ–∞–Ω–∏–º–∞—Ü–∏–∏).
    
    ‚úÇÔ∏è **–ì–î–ï –†–ï–ó–ê–¢–¨ –ö–û–°–¢–´:**
    (–ù–∞–ø–∏—à–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ, –∫–∞–∫—É—é –∫–∞—Ç–µ–≥–æ—Ä–∏—é —Ä–∞—Å—Ö–æ–¥–æ–≤ –Ω–∞–¥–æ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –∫–∞–∫ –µ—ë —É–º–µ–Ω—å—à–∏—Ç—å. –ù–∞–ø—Ä–∏–º–µ—Ä: "–ó–∞—Ä–ø–ª–∞—Ç–∞ —Å–ª–∏—à–∫–æ–º —Ä–∞–∑–¥—É—Ç–∞, –ø–µ—Ä–µ–≤–æ–¥–∏ –∞–¥–º–∏–Ω–æ–≤ –Ω–∞ % –æ—Ç –≤—ã—Ä—É—á–∫–∏").
    
    üöÄ **–¢–û–ß–ö–ò –†–û–°–¢–ê:**
    (2 –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Å–æ–≤–µ—Ç–∞ –∫–∞–∫ –ø–æ–¥–Ω—è—Ç—å –≤—ã—Ä—É—á–∫—É, –∏—Å—Ö–æ–¥—è –∏–∑ —Ç—Ä–µ–Ω–¥–∞).
    
    ‚ö†Ô∏è **–†–ò–°–ö–ò:**
    (–ü—Ä–æ–∫–æ–º–º–µ–Ω—Ç–∏—Ä—É–π –∞–Ω–æ–º–∞–ª–∏–∏, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å. –ü–æ—á–µ–º—É –≤ —ç—Ç–∏ –¥–∞—Ç—ã –±—ã–ª–∏ —Å–±–æ–∏?).

    –ü–∏—à–∏ –∫—Ä–∞—Ç–∫–æ. –ò—Å–ø–æ–ª—å–∑—É–π –¥–µ–ª–æ–≤–æ–π —Å—Ç–∏–ª—å. –ù–µ —Ö–≤–∞–ª–∏, –µ—Å–ª–∏ —Ü–∏—Ñ—Ä—ã –ø–ª–æ—Ö–∏–µ.
  `;

  try {
    const response = await fetch(
      `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`,
      {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }),
      }
    );

    const json = await response.json();
    
    if (!response.ok || json.error) {
       console.error("AI Error:", json);
       return "–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏–∑–∞.";
    }

    const text = json.candidates?.[0]?.content?.parts?.[0]?.text;
    return text || "–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ—Ç –ò–ò.";
    
  } catch (error) {
    console.error(error);
    return "–û—à–∏–±–∫–∞ —Å–µ—Ç–∏.";
  }
}
